<html>
<head>
<title>Ceremonial counties of England quiz</title>
</head>
<body>
<a href="https://github.com/hickford/counties-quiz"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
<div style="float:left;">
<h1>Ceremonial counties</h1>
<p>
Which is the red county?
<input id="input" autofocus>
</p>
<p>If you get stuck, type 'hint'.</p>
<p>Score: <input id="score" value="0" readonly> out of <input id="answered" readonly></p>
</div>
<div >
    <object id="map" data="English_ceremonial_counties_1998_(named).svg" style="height:90%;visibility:hidden;"/> 
</div>
    <script src="underscore-min.js"></script>
    <script src="underscore.string.min.js"></script>
    <script>
    // necessary
    _.mixin(_.string.exports());
    window.onload=function() {
        var score = 0;
        var answered = 0;

        var map = document.getElementById("map");
        var sdoc = map.contentDocument;
        var svg = sdoc.getElementsByTagName("svg")[0];

        // hack for size

        if (!svg.getAttribute("viewBox")) {
            svg.setAttribute("viewBox", "0 0 " + svg.getAttribute("width") + " " + svg.getAttribute("height"));
        }

        ids_to_text = {};
        var texts = sdoc.getElementsByTagName("text");
        _.each(texts, function(text) {
            text.style.visibility = "hidden";
            var id = text.textContent; // unfortunately, no spaces between text nodes (eg. CountyDurham)
            id = _.unescapeHTML(id);  // for &amp; and the rest
            id = id.replace("-",""); // for wrapped lines
            id = _.humanize(id); // assuming camel case, restore spaces 
            id = id.toLowerCase();
            ids_to_text[id] = text;
        });
        map.style.visibility = "visible";

        var paths = sdoc.getElementsByTagName("path");
        var rejects = ["Northern Ireland", "Ireland"];
        paths = _(paths).reject(function(x) {return _.string.startsWith(x.id, "path")});
        paths = _(paths).reject(function(x) {return _.contains(rejects, x.id)});

        ids_to_path = {};
        _.each(paths, function(path) {
            ids_to_path[path.id.toLowerCase()] = path;
        });

        paths = _.shuffle(paths);

        var path = paths.pop();
        var oldFill = path.style.fill;
        path.style.fill = "red";

        var badPath = undefined;
        var badPathOldFill = undefined;

        var first = true;

        var ask = function() {
            path.style.fill = oldFill;
            path = paths.pop();

            if (path) {
                oldFill = path.style.fill;
                path.style.fill = "red";
                first = true;
            } else {
                document.getElementById("input").placeholder = "Game over";
                document.getElementById("input").readOnly = true;
            }
        };

        document.getElementById("input").oninput = function()
        {
            if (badPath) {
                badPath.style.fill = badPathOldFill;
            }

            var value = _(this.value).clean().toLowerCase();
            if (value === path.id.toLowerCase()) {
                answered += 1;
                document.getElementById("answered").value = answered;

                if (first) {
                    score += 1;
                    document.getElementById("score").value = score;
                }

                if (ids_to_text[value]) {
                    ids_to_text[value].style.visibility = "visible";
                }

                this.value = "";
                this.placeholder = "";

                ask();
            }
            else if (value === "hint")
            {
                first = false;
                this.placeholder = path.id;
                this.value = "";
            }
            else if (ids_to_path[value])
            {
                first = false;
                badPathOldFill = ids_to_path[value].style.fill;
                ids_to_path[value].style.fill = "black";
                badPath = ids_to_path[value];
            }
        };
}
    </script>
</body>
</html>